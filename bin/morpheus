#!/usr/bin/env ruby
require 'term/ansicolor'
require 'optparse'
require 'morpheus/cli'
require 'morpheus/rest_client'
require 'morpheus/cli/cli_registry'
require 'morpheus/cli/config_file'
require 'morpheus/cli/error_handler'

# use colors by default
Term::ANSIColor::coloring = STDOUT.isatty
# include Term::ANSIColor # tempting

# short circuit version switch
if ARGV[0] == '-v'
  version = Morpheus::Cli::VERSION
  puts version
  exit 0
end

args = ARGV.dup

# raise log level right away
if args.find {|it| it == '-V' || it == '--debug'}
  Morpheus::Logging.set_log_level(Morpheus::Logging::Logger::DEBUG)
end

# load config file(s)
Morpheus::Cli::ConfigFile.init(ENV['MORPHEUS_CLI_HOME'])

# all commands should be registered commands or aliases
if Morpheus::Cli::CliRegistry.has_command?(args[0]) || Morpheus::Cli::CliRegistry.has_alias?(args[0])
  begin
    cmd_result = Morpheus::Cli::CliRegistry.exec(args[0], args[1..-1])
    if cmd_result == false
      exit 1
    else
      exit 0
    end
  rescue => e
    Morpheus::Cli::ErrorHandler.new.handle_error(e)
    exit 1
  end
else
  puts "Usage: morpheus [command] [options]"
  puts "\nCommands:"
  Morpheus::Cli::CliRegistry.all.keys.sort.each {|cmd|
    puts "\t#{cmd.to_s}"
  }
  puts ""
  puts "For more information, see https://github.com/gomorpheus/morpheus-cli/wiki"
  puts ""
  exit 127
end
